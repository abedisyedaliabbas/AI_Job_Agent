{% extends "base.html" %}

{% block title %}Search Jobs - AI Job Agent{% endblock %}

{% block content %}
<div class="main-container">
    <div class="mb-3">
        <h3 class="fw-bold mb-1">Search Jobs Worldwide</h3>
        <p class="text-muted small mb-0">Find jobs from multiple countries and job boards</p>
    </div>
    
    <div class="card mb-3">
        <div class="card-body p-3">
            <form id="searchForm">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label fw-semibold small">Job Keywords</label>
                        <input type="text" class="form-control" id="keywords" 
                               placeholder="e.g., software engineer, data scientist, marketing manager" 
                               value="">
                        <small class="text-muted">Separate keywords with commas</small>
                    </div>
                    
                    <div class="col-12">
                        <label class="form-label fw-semibold small">Location (Select Multiple)</label>
                        <select class="form-select" id="locationSelect" multiple size="6">
                            <option value="Worldwide" selected>üåç Worldwide</option>
                            <optgroup label="Popular">
                                <option value="Singapore">üá∏üá¨ Singapore</option>
                                <option value="United States">üá∫üá∏ United States</option>
                                <option value="United Kingdom">üá¨üáß United Kingdom</option>
                                <option value="Australia">üá¶üá∫ Australia</option>
                                <option value="Canada">üá®üá¶ Canada</option>
                                <option value="Germany">üá©üá™ Germany</option>
                                <option value="Japan">üáØüáµ Japan</option>
                                <option value="Hong Kong">üá≠üá∞ Hong Kong</option>
                                <option value="Malaysia">üá≤üáæ Malaysia</option>
                                <option value="Thailand">üáπüá≠ Thailand</option>
                            </optgroup>
                            <optgroup label="Asia">
                                {% for country in countries %}
                                {% if "Asia" in country.regions and country.code != "WW" and country.name not in ["Singapore", "Hong Kong", "Malaysia", "Thailand", "Japan"] %}
                                <option value="{{ country.name }}">{{ country.name }}</option>
                                {% endif %}
                                {% endfor %}
                            </optgroup>
                            <optgroup label="Europe">
                                {% for country in countries %}
                                {% if "Europe" in country.regions and country.code != "WW" and country.name not in ["United Kingdom", "Germany"] %}
                                <option value="{{ country.name }}">{{ country.name }}</option>
                                {% endif %}
                                {% endfor %}
                            </optgroup>
                            <optgroup label="North America">
                                {% for country in countries %}
                                {% if "North America" in country.regions and country.code != "WW" and country.name not in ["United States", "Canada"] %}
                                <option value="{{ country.name }}">{{ country.name }}</option>
                                {% endif %}
                                {% endfor %}
                            </optgroup>
                            <optgroup label="Other Regions">
                                {% for country in countries %}
                                {% if "Asia" not in country.regions and "Europe" not in country.regions and "North America" not in country.regions and country.code != "WW" and country.name != "Australia" %}
                                <option value="{{ country.name }}">{{ country.name }}</option>
                                {% endif %}
                                {% endfor %}
                            </optgroup>
                        </select>
                        <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label fw-semibold small">Job Type</label>
                        <select class="form-select" id="jobType">
                            <option value="">All Types</option>
                            <option value="full-time">Full Time</option>
                            <option value="part-time">Part Time</option>
                            <option value="contract">Contract</option>
                            <option value="internship">Internship</option>
                            <option value="remote">Remote</option>
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label fw-semibold small">Min Salary (Optional)</label>
                        <input type="number" class="form-control" id="minSalary" placeholder="e.g., 5000">
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label fw-semibold small">Max Results</label>
                        <input type="number" class="form-control" id="maxResults" value="50" min="10" max="200">
                    </div>
                </div>
                
                <div class="mt-3 d-flex gap-2 flex-wrap">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search me-1"></i>Search Jobs
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="getUrlsBtn">
                        <i class="bi bi-link-45deg me-1"></i>Get Search URLs
                    </button>
                    <a href="/add_job" class="btn btn-outline-success">
                        <i class="bi bi-plus-circle me-1"></i>Add Job URL
                    </a>
                </div>
            </form>
        </div>
    </div>

    <div id="searchResults" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
            <h5 class="mb-0 small fw-semibold">Search Results</h5>
            <div class="d-flex gap-2 flex-wrap">
                <span id="resultsCount" class="badge bg-primary"></span>
                <button class="btn btn-sm btn-success" id="saveJobsBtn" style="display: none;">
                    <i class="bi bi-bookmark me-1"></i>Save to My Jobs
                </button>
                <button class="btn btn-sm btn-primary" id="generateCoversSearchBtn" style="display: none;">
                    <i class="bi bi-file-text me-1"></i>Generate Covers
                </button>
                <button class="btn btn-sm btn-danger" id="applyAllSearchBtn" style="display: none;">
                    <i class="bi bi-send-check me-1"></i>Apply All
                </button>
            </div>
        </div>
        <div id="jobsList"></div>
    </div>

    <div id="searchUrls" class="mt-3" style="display: none;">
        <div class="card">
            <div class="card-body p-3">
                <h6 class="card-title fw-semibold"><i class="bi bi-link-45deg me-1"></i>Job Board Search URLs</h6>
                <div id="urlsList"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    $('#searchForm').on('submit', function(e) {
        e.preventDefault();
        searchJobs();
    });

    $('#getUrlsBtn').on('click', function() {
        getSearchUrls();
    });

    function searchJobs() {
        const keywords = $('#keywords').val().split(',').map(k => k.trim()).filter(k => k);
        const selectedLocations = $('#locationSelect').val() || [];
        const jobType = $('#jobType').val();
        const minSalary = $('#minSalary').val();
        const maxResults = $('#maxResults').val();

        if (keywords.length === 0) {
            alert('Please enter at least one keyword');
            return;
        }
        
        // Show loading
        $('#jobsList').html(`
            <div class="text-center py-4">
                <div class="spinner-border text-primary mb-2" role="status"></div>
                <p class="text-muted small mb-0">Searching jobs worldwide...</p>
                <p class="text-muted small">Locations: ${selectedLocations.length > 0 ? selectedLocations.join(', ') : 'Worldwide'}</p>
            </div>
        `);
        $('#searchResults').show();
        
        const submitBtn = $('#searchForm button[type="submit"]');
        submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>Searching...');

        $.ajax({
            url: '/search',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                keywords: keywords,
                locations: selectedLocations,
                job_type: jobType,
                min_salary: minSalary,
                max_results: parseInt(maxResults)
            }),
            success: function(response) {
                submitBtn.prop('disabled', false).html('<i class="bi bi-search me-1"></i>Search Jobs');
                
                if (response.success) {
                    displayJobs(response.jobs);
                    $('#resultsCount').text(`${response.count} jobs`);
                } else {
                    $('#jobsList').html('<div class="alert alert-danger small">Search failed: ' + (response.error || 'Unknown error') + '</div>');
                }
            },
            error: function(xhr) {
                submitBtn.prop('disabled', false).html('<i class="bi bi-search me-1"></i>Search Jobs');
                const errorMsg = xhr.responseJSON?.error || 'Search failed. Try "Get Search URLs" for manual search.';
                $('#jobsList').html(`
                    <div class="alert alert-warning small">
                        <strong>Search Issue:</strong> ${errorMsg}
                        <div class="mt-2">
                            <button class="btn btn-sm btn-primary" id="getUrlsBtnInline">
                                <i class="bi bi-link-45deg me-1"></i>Get Search URLs
                            </button>
                        </div>
                    </div>
                `);
                $('#getUrlsBtnInline').on('click', getSearchUrls);
            }
        });
    }

    function displayJobs(jobs) {
        if (jobs.length === 0) {
            $('#jobsList').html(`
                <div class="alert alert-info small">
                    <strong>No Jobs Found</strong>
                    <p class="mb-2 mt-2">Try:</p>
                    <ul class="mb-2">
                        <li>Use "Get Search URLs" to search manually</li>
                        <li>Add jobs using "Add Job URL"</li>
                        <li>Try different keywords</li>
                    </ul>
                    <button class="btn btn-sm btn-primary me-1" id="getUrlsBtnInline2">
                        <i class="bi bi-link-45deg me-1"></i>Get URLs
                    </button>
                    <a href="/add_job" class="btn btn-sm btn-success">
                        <i class="bi bi-plus-circle me-1"></i>Add Job
                    </a>
                </div>
            `);
            $('#getUrlsBtnInline2').on('click', getSearchUrls);
        } else {
            let html = '';
            jobs.forEach((job, index) => {
                const matchBadge = job.match_score ? 
                    `<span class="badge bg-success ms-1">${(job.match_score * 100).toFixed(0)}%</span>` : '';
                const sourceBadge = job.source === 'sample-generated' ? 
                    `<span class="badge bg-secondary ms-1">Sample</span>` : '';
                html += `
                    <div class="card job-card mb-2" data-job-index="${index}">
                        <div class="card-body p-3">
                            <div class="form-check mb-2">
                                <input class="form-check-input job-checkbox-search" type="checkbox" 
                                       value="${index}" id="searchJob${index}">
                                <label class="form-check-label" for="searchJob${index}"></label>
                            </div>
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 small fw-semibold">
                                        ${job.title}
                                        ${matchBadge}
                                        ${sourceBadge}
                                    </h6>
                                    <p class="text-muted small mb-1">
                                        <i class="bi bi-building me-1"></i>${job.company}
                                        <span class="ms-2"><i class="bi bi-geo-alt me-1"></i>${job.location}</span>
                                    </p>
                                    <p class="small text-muted mb-1">${job.description}</p>
                                    <small class="text-muted">
                                        <i class="bi bi-tag me-1"></i>${job.source || 'Unknown'}
                                    </small>
                                </div>
                                <div class="ms-2 d-flex flex-column gap-1">
                                    ${job.url && !job.url.startsWith('#') ? 
                                        `<a href="${job.url}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-box-arrow-up-right"></i>
                                        </a>` : ''}
                                    <button class="btn btn-sm btn-outline-success generateCoverBtn" data-job-index="${index}">
                                        <i class="bi bi-file-text"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            $('#jobsList').html(html);
            
            // Show action buttons
            $('#saveJobsBtn, #generateCoversSearchBtn, #applyAllSearchBtn').show();
            
            // Store jobs globally for later use
            window.searchJobs = jobs;
            
            // Attach event handlers
            $('.job-checkbox-search').on('change', function() {
                updateSearchButtons();
            });
            
            $('.generateCoverBtn').on('click', function() {
                const jobIndex = $(this).data('job-index');
                generateAndPreviewCover(jobs[jobIndex]);
            });
            
            updateSearchButtons();
        }
    }

    function updateSearchButtons() {
        const checked = $('.job-checkbox-search:checked').length;
        const total = $('.job-checkbox-search').length;
        
        if (checked > 0) {
            $('#generateCoversSearchBtn').html(`<i class="bi bi-file-text me-1"></i>Generate Covers (${checked})`);
            $('#applyAllSearchBtn').html(`<i class="bi bi-send-check me-1"></i>Apply Selected (${checked})`);
        } else {
            $('#generateCoversSearchBtn').html(`<i class="bi bi-file-text me-1"></i>Generate Covers (${total})`);
            $('#applyAllSearchBtn').html(`<i class="bi bi-send-check me-1"></i>Apply All (${total})`);
        }
    }
    
    function generateAndPreviewCover(job) {
        // Show loading
        const modal = $('#coverLetterModal');
        modal.find('.modal-body').html(`
            <div class="text-center py-4">
                <div class="spinner-border text-primary mb-2" role="status"></div>
                <p class="text-muted small">Generating cover letter...</p>
            </div>
        `);
        modal.modal('show');
        
        $.ajax({
            url: '/api/generate_cover',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ job: job }),
            success: function(response) {
                if (response.success) {
                    displayCoverLetterPreview(response.cover_letter, job, response.filename);
                } else {
                    modal.find('.modal-body').html(`
                        <div class="alert alert-danger">Error: ${response.error || 'Failed to generate cover letter'}</div>
                    `);
                }
            },
            error: function(xhr) {
                modal.find('.modal-body').html(`
                    <div class="alert alert-danger">Error: ${xhr.responseJSON?.error || 'Failed to generate cover letter'}</div>
                `);
            }
        });
    }
    
    function displayCoverLetterPreview(coverLetter, job, filename) {
        const modal = $('#coverLetterModal');
        modal.find('.modal-title').text(`Cover Letter - ${job.title} at ${job.company}`);
        
        let html = `
            <div class="mb-3">
                <label class="form-label fw-semibold">Cover Letter (Editable)</label>
                <textarea class="form-control" id="coverLetterText" rows="15" style="font-family: monospace; font-size: 0.9em;">${coverLetter}</textarea>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" id="saveCoverBtn" data-filename="${filename}" data-job-title="${job.title}" data-company="${job.company}">
                    <i class="bi bi-save me-1"></i>Save & Apply
                </button>
                <button class="btn btn-outline-secondary" id="downloadCoverBtn" data-filename="${filename}">
                    <i class="bi bi-download me-1"></i>Download
                </button>
                <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        `;
        
        modal.find('.modal-body').html(html);
        
        $('#saveCoverBtn').on('click', function() {
            const editedCover = $('#coverLetterText').val();
            const filename = $(this).data('filename');
            const jobTitle = $(this).data('job-title');
            const company = $(this).data('company');
            
            // Save edited cover letter
            $.ajax({
                url: '/api/save_cover',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    cover_letter: editedCover,
                    filename: filename,
                    job_title: jobTitle,
                    company: company
                }),
                success: function(response) {
                    if (response.success) {
                        alert('Cover letter saved! Application prepared.');
                        modal.modal('hide');
                    } else {
                        alert('Error saving: ' + (response.error || 'Unknown error'));
                    }
                },
                error: function() {
                    alert('Error saving cover letter');
                }
            });
        });
        
        $('#downloadCoverBtn').on('click', function() {
            const filename = $(this).data('filename');
            const editedCover = $('#coverLetterText').val();
            
            // Create download link
            const blob = new Blob([editedCover], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        });
    }
    
    $('#saveJobsBtn').on('click', function() {
        if (!window.searchJobs || window.searchJobs.length === 0) {
            alert('No jobs to save');
            return;
        }
        
        const btn = $(this);
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>Saving...');
        
        $.ajax({
            url: '/api/save_search_jobs',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ jobs: window.searchJobs }),
            success: function(response) {
                btn.prop('disabled', false).html('<i class="bi bi-bookmark me-1"></i>Save to My Jobs');
                if (response.success) {
                    alert(`Successfully saved ${response.count} jobs to My Jobs!`);
                    window.location.href = '/jobs';
                } else {
                    alert('Error: ' + (response.error || 'Failed to save jobs'));
                }
            },
            error: function(xhr) {
                btn.prop('disabled', false).html('<i class="bi bi-bookmark me-1"></i>Save to My Jobs');
                alert('Error: ' + (xhr.responseJSON?.error || 'Failed to save jobs'));
            }
        });
    });
    
    $('#generateCoversSearchBtn').on('click', function() {
        const checked = $('.job-checkbox-search:checked').map(function() {
            return parseInt($(this).val());
        }).get();
        
        const jobsToProcess = checked.length > 0 ? 
            checked.map(i => window.searchJobs[i]) : 
            window.searchJobs;
        
        if (jobsToProcess.length === 0) {
            alert('No jobs selected');
            return;
        }
        
        const btn = $(this);
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>Generating...');
        
        // Generate covers for all jobs
        let generated = 0;
        let failed = 0;
        
        jobsToProcess.forEach((job, idx) => {
            setTimeout(() => {
                $.ajax({
                    url: '/api/generate_cover',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ job: job }),
                    success: function(response) {
                        generated++;
                        if (generated + failed === jobsToProcess.length) {
                            btn.prop('disabled', false).html('<i class="bi bi-file-text me-1"></i>Generate Covers');
                            alert(`Generated ${generated} cover letters! ${failed > 0 ? `(${failed} failed)` : ''}`);
                        }
                    },
                    error: function() {
                        failed++;
                        if (generated + failed === jobsToProcess.length) {
                            btn.prop('disabled', false).html('<i class="bi bi-file-text me-1"></i>Generate Covers');
                            alert(`Generated ${generated} cover letters! ${failed > 0 ? `(${failed} failed)` : ''}`);
                        }
                    }
                });
            }, idx * 500); // Stagger requests
        });
    });
    
    $('#applyAllSearchBtn').on('click', function() {
        const checked = $('.job-checkbox-search:checked').map(function() {
            return parseInt($(this).val());
        }).get();
        
        const jobsToApply = checked.length > 0 ? 
            checked.map(i => window.searchJobs[i]) : 
            window.searchJobs;
        
        if (jobsToApply.length === 0) {
            alert('No jobs selected');
            return;
        }
        
        if (!confirm(`Apply to ${jobsToApply.length} jobs? Cover letters will be generated automatically.`)) {
            return;
        }
        
        const btn = $(this);
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>Applying...');
        
        // First save jobs, then apply
        $.ajax({
            url: '/api/save_search_jobs',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ jobs: jobsToApply }),
            success: function(response) {
                if (response.success) {
                    // Now apply to saved jobs
                    window.location.href = '/jobs?apply=true';
                } else {
                    btn.prop('disabled', false).html('<i class="bi bi-send-check me-1"></i>Apply All');
                    alert('Error saving jobs: ' + (response.error || 'Unknown error'));
                }
            },
            error: function(xhr) {
                btn.prop('disabled', false).html('<i class="bi bi-send-check me-1"></i>Apply All');
                alert('Error: ' + (xhr.responseJSON?.error || 'Failed'));
            }
        });
    });
    
    function getSearchUrls() {
        const keywords = $('#keywords').val().split(',').map(k => k.trim()).filter(k => k);
        const selectedLocations = $('#locationSelect').val() || ['Worldwide'];
        const location = selectedLocations.length > 0 ? selectedLocations[0] : 'Worldwide';

        $.ajax({
            url: '/api/search_urls',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                keywords: keywords,
                location: location
            }),
            success: function(response) {
                if (response.success) {
                    let html = '<div class="list-group list-group-flush">';
                    for (const [platform, url] of Object.entries(response.urls)) {
                        html += `
                            <a href="${url}" target="_blank" class="list-group-item list-group-item-action small">
                                <strong>${platform}</strong>
                                <br><span class="text-muted">${url}</span>
                            </a>
                        `;
                    }
                    html += '</div>';
                    $('#urlsList').html(html);
                    $('#searchUrls').show();
                }
            }
        });
    }
});
</script>
{% endblock %}
