{% extends "base.html" %}

{% block title %}Upload Resume - AI Job Agent{% endblock %}

{% block content %}
<div class="main-container">
    <h2 class="mb-4"><i class="bi bi-upload me-2"></i>Upload Your Resume</h2>
    
    {% if existing_profile %}
    <!-- AI Agent Section - Prominent -->
    <div class="card border-success shadow-sm mb-4" style="border-width: 2px;">
        <div class="card-body p-4">
            <div class="d-flex align-items-center mb-3">
                <i class="bi bi-robot display-4 text-success me-3"></i>
                <div>
                    <h4 class="mb-1 fw-bold">ğŸ¤– AI Job Agent Ready!</h4>
                    <p class="text-muted mb-0">Your resume is uploaded. Let the AI agent find matching jobs for you.</p>
                </div>
            </div>
            
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <div class="card bg-light h-100">
                        <div class="card-body p-3">
                            <h6 class="fw-bold mb-2"><i class="bi bi-person-badge me-2"></i>Your Profile</h6>
                            <ul class="mb-0 small">
                                <li><strong>Name:</strong> {{ existing_profile.name }}</li>
                                <li><strong>Email:</strong> {{ existing_profile.email }}</li>
                                <li><strong>Location:</strong> {{ existing_profile.location or 'Not specified' }}</li>
                                <li><strong>Experience:</strong> {{ existing_profile.experience_count }} positions</li>
                                <li><strong>Education:</strong> {{ existing_profile.education_count }} degrees</li>
                                <li><strong>Publications:</strong> {{ existing_profile.publications_count }} papers</li>
                                <li><strong>Skills:</strong> {{ existing_profile.skills_count }} skills</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card bg-light h-100">
                        <div class="card-body p-3">
                            <h6 class="fw-bold mb-2"><i class="bi bi-lightning-charge me-2"></i>What AI Agent Does</h6>
                            <ol class="mb-0 small">
                                <li>Analyzes your resume & skills</li>
                                <li>Searches jobs worldwide</li>
                                <li>Matches jobs to your profile</li>
                                <li>Generates personalized cover letters</li>
                                <li>Prepares applications for review</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-success btn-lg px-4" id="useExistingBtn" style="font-size: 1.1rem;">
                    <i class="bi bi-robot me-2"></i>ğŸš€ Start AI Agent: Find Jobs Now
                </button>
                <button class="btn btn-outline-secondary" id="uploadNewBtn">
                    <i class="bi bi-upload me-2"></i>Upload New Resume
                </button>
                <a href="/dashboard" class="btn btn-outline-primary">
                    <i class="bi bi-speedometer2 me-2"></i>Go to Dashboard
                </a>
            </div>
            
            <!-- AI Agent Progress -->
            <div id="autoSearchProgress" class="mt-3" style="display: none;">
                <div class="alert alert-info d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-3" role="status"></div>
                    <div>
                        <strong>AI Agent Working...</strong><br>
                        <span id="autoSearchStatus" class="small">Analyzing your resume and searching for matching jobs worldwide...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="upload-area" id="uploadArea" {% if existing_profile %}style="display: none;"{% endif %}>
        <i class="bi bi-cloud-upload display-1 text-primary mb-3"></i>
        <h4>Drag & Drop your resume here</h4>
        <p class="text-muted">or click to browse</p>
        <input type="file" id="fileInput" class="d-none" accept=".pdf,.doc,.docx,.txt">
        <button class="btn btn-primary mt-3" onclick="document.getElementById('fileInput').click()">
            <i class="bi bi-folder2-open me-2"></i>Choose File
        </button>
        <p class="text-muted mt-2 small">Supported formats: PDF, DOC, DOCX, TXT (Max 16MB)</p>
    </div>

    <div id="uploadProgress" class="mt-4" style="display: none;">
        <div class="progress" style="height: 30px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" style="width: 0%"></div>
        </div>
        <p class="text-center mt-2" id="progressText">Uploading...</p>
    </div>

    <div id="uploadResult" class="mt-4" style="display: none;">
        <div class="alert alert-success">
            <h5><i class="bi bi-check-circle me-2"></i>Resume Uploaded Successfully!</h5>
            <div id="profileInfo"></div>
            <hr>
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-success" id="autoSearchBtn">
                    <i class="bi bi-robot me-2"></i>AI Agent: Auto-Search Jobs
                </button>
                <a href="/search" class="btn btn-outline-primary">
                    <i class="bi bi-search me-2"></i>Manual Search
                </a>
                <a href="/dashboard" class="btn btn-outline-secondary">
                    <i class="bi bi-speedometer2 me-2"></i>Dashboard
                </a>
            </div>
            <div id="autoSearchProgress" class="mt-3" style="display: none;">
                <div class="alert alert-info">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <span id="autoSearchStatus">AI Agent is searching for jobs based on your resume...</span>
                </div>
            </div>
        </div>
    </div>

    <div id="uploadError" class="mt-4" style="display: none;">
        <div class="alert alert-danger">
            <h5><i class="bi bi-exclamation-triangle me-2"></i>Upload Failed</h5>
            <p id="errorMessage"></p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    const uploadArea = $('#uploadArea');
    const fileInput = $('#fileInput');
    const uploadProgress = $('#uploadProgress');
    const uploadResult = $('#uploadResult');
    const uploadError = $('#uploadError');
    
    // Country selection for upload page
    let selectedCountryUpload = 'Worldwide';
    
    // Handle "Use Existing Resume" button - show country selection first
    $(document).on('click', '#useExistingBtn', function() {
        // Show country selection modal
        {% if existing_profile and existing_profile.location %}
        $('#jobSearchCountryUpload').val('{{ existing_profile.location }}');
        selectedCountryUpload = '{{ existing_profile.location }}';
        {% endif %}
        
        const modal = new bootstrap.Modal(document.getElementById('countrySelectionModalUpload'));
        modal.show();
    });
    
    // Handle country selection confirmation on upload page
    $(document).on('click', '#confirmCountrySearchUpload', function() {
        selectedCountryUpload = $('#jobSearchCountryUpload').val();
        bootstrap.Modal.getInstance(document.getElementById('countrySelectionModalUpload')).hide();
        
        const btn = $('#useExistingBtn');
        const progressDiv = $('#autoSearchProgress');
        const statusSpan = $('#autoSearchStatus');
        
        // Show progress immediately
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Starting AI Agent...');
        progressDiv.show();
        statusSpan.html(`<strong>AI Agent Working...</strong><br>Analyzing your resume and searching for matching jobs in ${selectedCountryUpload}...`);
        
        // Call auto-search API
        $.ajax({
            url: '/api/auto_search',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                max_jobs: 15,
                min_match_score: 0.4,
                auto_apply: false,
                location: selectedCountryUpload
            }),
            success: function(response) {
                if (response.success) {
                    let statusHtml = `<div class="alert alert-success mb-2">
                        <strong>âœ… AI Agent Complete!</strong><br>
                        Found ${response.jobs_found || 0} jobs | 
                        Matched ${response.jobs_matched || 0} jobs | 
                        Generated ${response.cover_letters_generated || 0} cover letters
                    </div>`;
                    
                    if (response.jobs && response.jobs.length > 0) {
                        statusHtml += `<div class="small mb-2"><strong>Top Matches:</strong><ul class="mb-0">`;
                        response.jobs.slice(0, 3).forEach(job => {
                            const matchPct = ((job.match_score || 0.5) * 100).toFixed(0);
                            statusHtml += `<li>${job.title} at ${job.company} (${matchPct}% match)</li>`;
                        });
                        statusHtml += `</ul></div>`;
                    }
                    
                    statusHtml += `<a href="/jobs" class="btn btn-primary btn-lg mt-2">
                        <i class="bi bi-briefcase me-2"></i>View All ${response.jobs_matched || 0} Jobs
                    </a>`;
                    
                    statusSpan.html(statusHtml);
                    btn.prop('disabled', false).html('<i class="bi bi-robot me-2"></i>ğŸš€ Start AI Agent: Find Jobs Now');
                } else {
                    let errorHtml = `<div class="alert alert-warning">
                        <strong>âš ï¸ No Jobs Found</strong><br>
                        ${response.message || response.error || 'Job boards often block automated scraping.'}
                    </div>`;
                    
                    if (response.jobs_found === 0) {
                        errorHtml += `
                            <div class="alert alert-info mt-2">
                                <strong>ğŸ’¡ What to do:</strong><br>
                                <ul class="mb-0 small">
                                    <li>Use <a href="/add_job" class="alert-link">Add Job</a> to add jobs by URL</li>
                                    <li>Search manually on <a href="https://www.indeed.com" target="_blank" class="alert-link">Indeed</a> or <a href="https://www.linkedin.com/jobs" target="_blank" class="alert-link">LinkedIn</a></li>
                                    <li>Copy job URLs and use the "Add Job" feature</li>
                                </ul>
                            </div>
                        `;
                    }
                    
                    statusSpan.html(errorHtml);
                    btn.prop('disabled', false).html('<i class="bi bi-robot me-2"></i>ğŸš€ Start AI Agent: Find Jobs Now');
                }
            },
            error: function(xhr) {
                statusSpan.html(`<div class="alert alert-danger">Error: ${xhr.responseJSON?.error || 'Failed to start AI agent. Please try again.'}</div>`);
                btn.prop('disabled', false).html('<i class="bi bi-robot me-2"></i>ğŸš€ Start AI Agent: Find Jobs Now');
            }
        });
    });
    
    // Handle "Upload New Resume" button
    $(document).on('click', '#uploadNewBtn', function() {
        uploadArea.slideDown();
        $(this).closest('.alert').slideUp();
    });

    // Drag and drop
    uploadArea.on('dragover', function(e) {
        e.preventDefault();
        $(this).css('background', '#e8ebff');
    });

    uploadArea.on('dragleave', function(e) {
        e.preventDefault();
        $(this).css('background', '#f8f9ff');
    });

    uploadArea.on('drop', function(e) {
        e.preventDefault();
        $(this).css('background', '#f8f9ff');
        const files = e.originalEvent.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });

    fileInput.on('change', function(e) {
        if (this.files.length > 0) {
            handleFile(this.files[0]);
        }
    });

    function handleFile(file) {
        if (!file) return;

        // Validate file type
        const allowedTypes = ['application/pdf', 'application/msword', 
                             'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 
                             'text/plain'];
        if (!allowedTypes.includes(file.type) && !file.name.match(/\.(pdf|doc|docx|txt)$/i)) {
            showError('Invalid file type. Please upload PDF, DOC, DOCX, or TXT files.');
            return;
        }

        // Validate file size (16MB)
        if (file.size > 16 * 1024 * 1024) {
            showError('File size exceeds 16MB limit.');
            return;
        }

        uploadFile(file);
    }

    function uploadFile(file) {
        const formData = new FormData();
        formData.append('resume', file);

        uploadProgress.show();
        uploadResult.hide();
        uploadError.hide();

        $.ajax({
            url: '/upload',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function() {
                const xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        $('.progress-bar').css('width', percentComplete + '%');
                        $('#progressText').text(`Uploading... ${Math.round(percentComplete)}%`);
                    }
                }, false);
                return xhr;
            },
            success: function(response) {
                uploadProgress.hide();
                if (response.success) {
                    showSuccess(response.profile);
                } else {
                    showError(response.error || 'Upload failed');
                }
            },
            error: function(xhr) {
                uploadProgress.hide();
                const error = xhr.responseJSON?.error || 'Upload failed. Please try again.';
                showError(error);
            }
        });
    }

    function showSuccess(profile) {
        let profileHtml = '<div class="mt-3"><strong>Profile Extracted:</strong><ul class="mt-2">';
        profileHtml += `<li><strong>Name:</strong> ${profile.name || 'Not found'}</li>`;
        profileHtml += `<li><strong>Email:</strong> ${profile.email || 'Not found'}</li>`;
        profileHtml += `<li><strong>Location:</strong> ${profile.location || 'Not specified'}</li>`;
        profileHtml += `<li><strong>Experience:</strong> ${profile.experience_count} positions</li>`;
        profileHtml += `<li><strong>Education:</strong> ${profile.education_count} degrees</li>`;
        profileHtml += `<li><strong>Publications:</strong> ${profile.publications_count} papers</li>`;
        profileHtml += `<li><strong>Skills:</strong> ${profile.skills_count} skills found</li>`;
        
        // Show parsed details if available
        if (profile.parsed_data) {
            if (profile.parsed_data.experiences && profile.parsed_data.experiences.length > 0) {
                profileHtml += '<li><strong>Recent Experience:</strong> ';
                profile.parsed_data.experiences.forEach(exp => {
                    profileHtml += `${exp.title} at ${exp.company}; `;
                });
                profileHtml += '</li>';
            }
            if (profile.parsed_data.skills && profile.parsed_data.skills.length > 0) {
                profileHtml += `<li><strong>Key Skills:</strong> ${profile.parsed_data.skills.slice(0, 5).join(', ')}</li>`;
            }
        }
        
        profileHtml += '</ul></div>';
        
        $('#profileInfo').html(profileHtml);
        uploadResult.show();
        
        // Enable auto-search button
        $('#autoSearchBtn').on('click', function() {
            autoSearchJobs();
        });
    }
    
    function autoSearchJobs() {
        $('#autoSearchProgress').show();
        $('#autoSearchStatus').text('AI Agent is analyzing your resume and searching for matching jobs...');
        
        $.ajax({
            url: '/api/auto_search',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                max_jobs: 10,
                min_match_score: 0.6,
                auto_apply: false
            }),
            success: function(response) {
                if (response.success) {
                    let statusHtml = `<strong>AI Agent Results:</strong><br>`;
                    statusHtml += `Found ${response.jobs_found} jobs | `;
                    statusHtml += `Matched ${response.jobs_matched} jobs | `;
                    statusHtml += `Generated ${response.cover_letters_generated} cover letters<br>`;
                    
                    if (response.jobs && response.jobs.length > 0) {
                        statusHtml += `<div class="mt-2"><strong>Top Jobs:</strong><ul class="small mt-1">`;
                        response.jobs.slice(0, 3).forEach(job => {
                            statusHtml += `<li>${job.title} at ${job.company} (${(job.match_score * 100).toFixed(0)}% match)</li>`;
                        });
                        statusHtml += `</ul></div>`;
                    }
                    
                    statusHtml += `<a href="/jobs" class="btn btn-sm btn-primary mt-2">View All ${response.jobs_matched} Jobs</a>`;
                    $('#autoSearchStatus').html(statusHtml);
                } else {
                    $('#autoSearchStatus').html(`
                        <strong>Error:</strong> ${response.error || 'Unknown error'}<br>
                        <small>Try using the manual search or add jobs by URL</small>
                    `);
                }
            },
            error: function(xhr) {
                $('#autoSearchStatus').text('Error: ' + (xhr.responseJSON?.error || 'Search failed'));
            }
        });
    }

    function showError(message) {
        $('#errorMessage').text(message);
        uploadError.show();
    }
    
    // Country Selection Modal for Upload Page
    const countryModalHtml = `
        <div class="modal fade" id="countrySelectionModalUpload" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title"><i class="bi bi-globe me-2"></i>Select Country for Job Search</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-3">Choose which country you want to search for jobs:</p>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Country/Location</label>
                            <select class="form-select form-select-lg" id="jobSearchCountryUpload">
                                <option value="Worldwide">ğŸŒ Worldwide (All Countries)</option>
                                <optgroup label="Popular">
                                    <option value="Singapore">ğŸ‡¸ğŸ‡¬ Singapore</option>
                                    <option value="United States">ğŸ‡ºğŸ‡¸ United States</option>
                                    <option value="United Kingdom">ğŸ‡¬ğŸ‡§ United Kingdom</option>
                                    <option value="Australia">ğŸ‡¦ğŸ‡º Australia</option>
                                    <option value="Canada">ğŸ‡¨ğŸ‡¦ Canada</option>
                                    <option value="Germany">ğŸ‡©ğŸ‡ª Germany</option>
                                    <option value="Japan">ğŸ‡¯ğŸ‡µ Japan</option>
                                    <option value="Hong Kong">ğŸ‡­ğŸ‡° Hong Kong</option>
                                    <option value="Malaysia">ğŸ‡²ğŸ‡¾ Malaysia</option>
                                    <option value="Thailand">ğŸ‡¹ğŸ‡­ Thailand</option>
                                </optgroup>
                                <optgroup label="Asia">
                                    <option value="China">ğŸ‡¨ğŸ‡³ China</option>
                                    <option value="India">ğŸ‡®ğŸ‡³ India</option>
                                    <option value="South Korea">ğŸ‡°ğŸ‡· South Korea</option>
                                    <option value="Taiwan">ğŸ‡¹ğŸ‡¼ Taiwan</option>
                                    <option value="Indonesia">ğŸ‡®ğŸ‡© Indonesia</option>
                                    <option value="Philippines">ğŸ‡µğŸ‡­ Philippines</option>
                                    <option value="Vietnam">ğŸ‡»ğŸ‡³ Vietnam</option>
                                </optgroup>
                                <optgroup label="Europe">
                                    <option value="France">ğŸ‡«ğŸ‡· France</option>
                                    <option value="Netherlands">ğŸ‡³ğŸ‡± Netherlands</option>
                                    <option value="Switzerland">ğŸ‡¨ğŸ‡­ Switzerland</option>
                                    <option value="Sweden">ğŸ‡¸ğŸ‡ª Sweden</option>
                                    <option value="Norway">ğŸ‡³ğŸ‡´ Norway</option>
                                    <option value="Denmark">ğŸ‡©ğŸ‡° Denmark</option>
                                    <option value="Spain">ğŸ‡ªğŸ‡¸ Spain</option>
                                    <option value="Italy">ğŸ‡®ğŸ‡¹ Italy</option>
                                </optgroup>
                                <optgroup label="Other">
                                    <option value="New Zealand">ğŸ‡³ğŸ‡¿ New Zealand</option>
                                    <option value="United Arab Emirates">ğŸ‡¦ğŸ‡ª United Arab Emirates</option>
                                    <option value="Saudi Arabia">ğŸ‡¸ğŸ‡¦ Saudi Arabia</option>
                                    <option value="Israel">ğŸ‡®ğŸ‡± Israel</option>
                                    <option value="Brazil">ğŸ‡§ğŸ‡· Brazil</option>
                                    <option value="South Africa">ğŸ‡¿ğŸ‡¦ South Africa</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="alert alert-info small mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Tip:</strong> You can search "Worldwide" to find jobs in all countries, or select a specific country for targeted results.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-success" id="confirmCountrySearchUpload">
                            <i class="bi bi-search me-2"></i>Start Search
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    $('body').append(countryModalHtml);
});
</script>
{% endblock %}
